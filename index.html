<!-- index.html - Update the head section and main content -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Feeds</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="appData()" x-init="init()">

    <div id="app-view">
        <div id="pull-to-refresh-indicator"></div>
        <nav class="top-nav" x-data="navComponent()">
             <div class="nav-left">
                <button id="refresh-btn" 
                        class="icon-button"
                        :class="{ 'loading': $store.ui.isLoading }"
                        @click="refresh()"
                        x-html="refreshIcon"></button>
                <div class="dropdown" x-data="{ open: false }">
                    <button class="nav-button" @click="open = !open">Feeds</button>
                    <div class="dropdown-content" 
                         x-show="open" 
                         @click.away="open = false"
                         x-transition>
                        <a href="#" @click="setFeed('home'); open = false" data-timeline="home">Home</a>
                        <a href="#" @click="setFeed('merged'); open = false" data-timeline="merged">Merged</a>
                        <hr>
                        <a href="#" @click="setFeed('lemmy'); open = false" id="lemmy-main-link">Lemmy</a>
                        <a href="#" @click="setFeed('mastodon'); open = false" id="mastodon-main-link">Mastodon</a>
                    </div>
                </div>
                <button id="discover-btn" class="nav-button" @click="$store.ui.currentView = 'discover'">Discover</button>
            </div>

            <div class="nav-center"></div>

            <div class="nav-right">
                <div class="dropdown" x-data="{ open: false }">
                    <button class="nav-button" @click="open = !open">Menu</button>
                    <div class="dropdown-content" 
                         x-show="open" 
                         @click.away="open = false"
                         x-transition>
                        <a href="#" @click="showComposeModal(); open = false" id="new-post-link">New Post</a>
                        <a href="#" @click="showProfile(); open = false" id="profile-link">Profile</a>
                        <a href="#" @click="$store.ui.currentView = 'settings'; open = false" id="settings-link">Settings</a>
                        <a href="#" @click="showHelp(); open = false" id="help-link">Help</a>
                    </div>
                </div>
                <button id="notifications-btn" 
                        class="icon-button"
                        :class="{ 'unread': hasUnreadNotifications }"
                        @click="showProfile()"
                        x-html="notificationIcon"></button>
            </div>
        </nav>
        
        <div id="loading-bar" :class="{ 'loading': $store.ui.isLoading }"></div>

        <div class="container">
            <!-- Timeline Sub Nav -->
            <div id="timeline-sub-nav" 
                 class="timeline-sub-nav"
                 x-show="$store.ui.currentView === 'timeline' && ($store.ui.currentTimeline || $store.ui.currentLemmyFeed)"
                 x-data="timelineSubNavComponent()">
                <div class="timeline-sub-nav-tabs">
                    <template x-if="$store.ui.currentLemmyFeed">
                        <div class="lemmy-tabs">
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'Subscribed' }"
                                    @click="setLemmyFeed('Subscribed')">Subbed</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'All' }"
                                    @click="setLemmyFeed('All')">All</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'Local' }"
                                    @click="setLemmyFeed('Local')">Local</button>
                        </div>
                    </template>
                    
                    <template x-if="$store.ui.currentTimeline">
                        <div class="mastodon-tabs">
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline === 'home' }"
                                    @click="setMastodonTimeline('home')">Subbed</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline === 'public' }"
                                    @click="setMastodonTimeline('public')">All</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline === 'public?local=true' }"
                                    @click="setMastodonTimeline('public?local=true')">Local</button>
                        </div>
                    </template>
                </div>
                
                <template x-if="$store.ui.currentLemmyFeed">
                    <div id="lemmy-filter-container">
                        <select id="lemmy-sort-select" 
                                x-model="$store.ui.currentLemmySort"
                                @change="setLemmyFeed($store.ui.currentLemmyFeed, $event.target.value)">
                            <option value="New">New</option>
                            <option value="Active">Active</option>
                            <option value="Hot">Hot</option>
                            <option value="TopHour">Top Hour</option>
                            <option value="TopSixHour">Top Six Hour</option>
                            <option value="TopTwelveHour">Top Twelve Hour</option>
                            <option value="TopDay">Top Day</option>
                        </select>
                    </div>
                </template>
            </div>

            <!-- Main Timeline -->
            <div id="timeline" 
                 class="view-container"
                 x-show="$store.ui.currentView === 'timeline'"
                 x-data="timelineComponent()" 
                 x-init="init()">
                 
                <!-- Loading State -->
                <template x-if="$store.ui.isLoading && $store.posts.length === 0">
                    <div class="loading-spinner">
                        <div class="loading-message">Loading your feed...</div>
                    </div>
                </template>
                
                <!-- Login Prompt -->
                <template x-if="!$store.ui.isLoading && $store.posts.length === 0 && needsLogin">
                    <div class="login-prompt" x-data="loginPromptComponent()">
                        <h3>Connect to get started</h3>
                        <p>Please log in to see your feed.</p>
                        <div class="login-options">
                            <button class="button-primary" @click="showMastodonLogin()">Connect Mastodon</button>
                            <button class="button-primary" @click="showLemmyLogin()">Connect Lemmy</button>
                        </div>
                    </div>
                </template>
                
                <!-- Posts -->
                <template x-if="!$store.ui.isLoading || $store.posts.length > 0">
                    <div class="posts-container">
                        <template x-for="(post, index) in $store.posts" :key="getPostKey(post)">
                            <div x-data="postComponent(post, index)" x-html="renderPost()"></div>
                        </template>
                    </div>
                </template>
                
                <!-- Load More -->
                <div id="scroll-loader" 
                     x-show="$store.posts.length > 0"
                     x-intersect="loadMore()">
                    <template x-if="$store.ui.loadingMore">
                        <p>Loading more posts...</p>
                    </template>
                    <template x-if="!$store.ui.loadingMore && !$store.ui.hasMore">
                        <p>No more posts.</p>
                    </template>
                </div>
            </div>

            <!-- Other Views (keep existing structure but add x-show) -->
            <div id="notifications-view" class="view-container" x-show="$store.ui.currentView === 'notifications'"></div>
            <div id="discover-view" class="view-container" x-show="$store.ui.currentView === 'discover'"></div>
            <div id="screenshot-view" class="view-container" x-show="$store.ui.currentView === 'screenshot'"></div>
            <div id="merged-post-view" class="view-container" x-show="$store.ui.currentView === 'mergedPost'"></div>
            <div id="profile-page-view" class="view-container" x-show="$store.ui.currentView === 'profile'"></div>
            <div id="edit-profile-view" class="view-container" x-show="$store.ui.currentView === 'editProfile'"></div>
            <div id="search-results-view" class="view-container" x-show="$store.ui.currentView === 'search'"></div>
            <div id="settings-view" class="view-container" x-show="$store.ui.currentView === 'settings'"></div>
            <div id="status-detail-view" class="view-container" x-show="$store.ui.currentView === 'statusDetail'"></div>
            <div id="lemmy-post-view" class="view-container" x-show="$store.ui.currentView === 'lemmyPost'"></div>
            <div id="lemmy-community-view" class="view-container" x-show="$store.ui.currentView === 'lemmyCommunity'"></div>
        </div>
        <div id="refresh-spinner" x-show="$store.ui.isLoading"></div>
    </div>
    
    <!-- Keep all your existing modals and other elements -->
    <div id="context-menu"></div>
    <div id="toast-notification"></div>
    
    <!-- Existing modals -->
    <div class="modal-overlay" id="compose-modal">
        <!-- Keep existing compose modal content -->
    </div>
    
    <div class="modal-overlay" id="image-modal">
        <!-- Keep existing image modal content -->
    </div>
    
    <div class="modal-overlay" id="help-modal">
        <!-- Keep existing help modal content -->
    </div>

    <!-- Keep existing templates -->
    <template id="screenshot-controls-template">
        <!-- Keep existing content -->
    </template>

    <template id="mastodon-login-template">
        <!-- Keep existing content -->
    </template>

    <template id="lemmy-login-template">
        <!-- Keep existing content -->
    </template>

    <!-- Update script imports -->
    <script src="components/store.js" type="module"></script>
    <script src="components/actions.js" type="module"></script>
    <script src="components/alpine-components.js" type="module"></script>
    <script src="app.js" type="module"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
