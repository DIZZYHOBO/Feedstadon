<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fediverse Client</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        :root {
            --bg-color: #030303;
            --card-color: #1A1A1B;
            --primary-color: #272729;
            --accent-color: #FF4500;
            --font-color: #D7DADC;
            --border-color: #343536;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding-top: 50px;
        }
        .container { max-width: 700px; margin: 0 auto; padding: 20px 10px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Navigation & Dropdowns */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: var(--card-color);
            border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between;
            align-items: center; padding: 0 10px; z-index: 2000;
        }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 10px; }
        .nav-button {
            background: none; border: 1px solid var(--border-color); color: var(--font-color); padding: 8px 12px;
            border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap;
        }
        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; top: 100%; left: 0; margin-top: 10px;
            background-color: var(--primary-color); border: 1px solid var(--border-color); border-radius: 8px;
            min-width: 160px; z-index: 1; overflow: hidden;
        }
        .nav-right .dropdown-content { left: auto; right: 0; }
        .dropdown-content a { color: var(--font-color); padding: 12px 16px; text-decoration: none; display: block; }
        .dropdown.active .dropdown-content { display: block; }
        
        /* Search Bar */
        .search-container { display: flex; align-items: center; }
        #search-form { width: 0; opacity: 0; transition: width 0.4s ease, opacity 0.4s ease; overflow: hidden; }
        #search-form.active { width: 200px; opacity: 1; }
        #search-input { margin-bottom: 0; }
        
        /* Main Content & Posts */
        #app-view { display: none; }
        #timeline { display: flex; flex-direction: column; gap: 12px; }
        .status { background-color: var(--card-color); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .status-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9em; }
        .status-header img { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .status-header .display-name { font-weight: bold; cursor: pointer; }
        .status-content { font-size: 1em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .status-content a { color: var(--accent-color); text-decoration: none; }
        .status-footer { font-size: 0.8em; color: #818384; margin-top: 15px; display: flex; align-items: center; font-weight: bold; }
        
        /* Modal, Profile, etc. */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: none; justify-content: center; align-items: flex-start;
            padding-top: 5vh; z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: var(--card-color); padding: 20px; border-radius: 8px; width: 90%; max-width: 600px;
            max-height: 85vh; overflow-y: auto;
        }
        
        /* NEW: Hashtag Autocomplete Styles */
        #autocomplete-container { position: relative; }
        #autocomplete-list {
            display: none;
            position: absolute;
            bottom: 100%; /* Position it above the compose box */
            left: 0;
            width: calc(100% - 20px);
            background-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        #autocomplete-list.visible { display: block; }
        #autocomplete-list div { padding: 10px; cursor: pointer; }
        #autocomplete-list div:hover { background-color: var(--border-color); }
    </style>
</head>
<body>

    <nav class="top-nav">
        </nav>

    <div class="container">
        <div id="login-view">
            </div>
        <div id="app-view">
            <div id="compose-view">
                <form id="compose-form">
                    <textarea id="compose-textarea" placeholder="What's on your mind?"></textarea>
                    <div id="autocomplete-container">
                        <div id="autocomplete-list"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button type="button" class="nav-button" id="trending-tags-btn">Trending #</button>
                        <button type="submit" id="post-btn">Post</button>
                    </div>
                </form>
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <div id="timeline"></div>
        </div>
    </div>
    
    <div id="modal" class="modal-overlay">
        <div class="modal-content" id="modal-body"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const timelineDiv = document.getElementById('timeline');
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');
            const composeForm = document.getElementById('compose-form');
            const composeTextarea = document.getElementById('compose-textarea');
            const trendingTagsBtn = document.getElementById('trending-tags-btn');
            const autocompleteList = document.getElementById('autocomplete-list');
            
            // Other element selectors as before...
            let instanceUrl = '', accessToken = '', currentUser = null;

            // --- API Helper & Modal ---
            async function apiFetch(endpoint, options = {}) {
                const url = `https://${instanceUrl}${endpoint}`;
                const headers = { 'Authorization': `Bearer ${accessToken}`, ...options.headers };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }
            function showModal(contentNode) { /* ... */ }
            function hideModal() { /* ... */ }
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

            // --- MODIFIED: renderStatus now makes hashtags clickable ---
            function renderStatus(status) {
                const originalPost = status.reblog || status;
                const isReblog = !!status.reblog;
                
                // Regex to find hashtags and wrap them
                let content = originalPost.content.replace(/#(\w+)/g, `<a href="#" class="hashtag">#$1</a>`);

                const statusDiv = document.createElement('div');
                statusDiv.className = 'status';
                statusDiv.innerHTML = `
                    ${isReblog ? `<div class="reblog-info">üîÅ Boosted by ${status.account.display_name}</div>` : ''}
                    <div class="status-header">
                        <img src="${originalPost.account.avatar_static}">
                        <div>
                            <span class="display-name">${originalPost.account.display_name}</span>
                            <span class="acct"> ¬∑ @${originalPost.account.acct}</span>
                        </div>
                    </div>
                    <div class="status-content">${content}</div>
                `;
                
                // Add click listeners to the new hashtag links
                statusDiv.querySelectorAll('.hashtag').forEach(tagEl => {
                    tagEl.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const tagName = e.target.textContent.substring(1); // Remove #
                        showHashtagFeed(tagName);
                    });
                });
                
                // Other listeners for profile, etc.
                statusDiv.querySelector('img').onclick = () => showProfile(originalPost.account.id);
                statusDiv.querySelector('.display-name').onclick = () => showProfile(originalPost.account.id);

                return statusDiv;
            }

            // --- NEW: Hashtag Feed & Autocomplete Logic ---
            async function showHashtagFeed(tagName) {
                const container = document.createElement('div');
                container.innerHTML = `<h2>#${tagName}</h2><p>Loading...</p>`;
                showModal(container);
                try {
                    const statuses = await apiFetch(`/api/v1/timelines/tag/${tagName}`);
                    const postsContainer = document.createElement('div');
                    postsContainer.style.cssText = 'display:flex; flex-direction:column; gap:10px;';
                    if (statuses.length > 0) {
                        statuses.forEach(s => postsContainer.appendChild(renderStatus(s)));
                    } else {
                        postsContainer.innerHTML = '<p>No posts found for this hashtag.</p>';
                    }
                    container.querySelector('p').remove(); // remove loading
                    container.appendChild(postsContainer);
                } catch(error) { container.innerHTML = `<p class="error">Could not load hashtag feed.</p>`; }
            }

            async function showTrendingTags() {
                try {
                    const tags = await apiFetch(`/api/v1/trends/tags?limit=4`);
                    autocompleteList.innerHTML = '';
                    if (tags.length > 0) {
                        tags.forEach(tag => {
                            const tagDiv = document.createElement('div');
                            tagDiv.textContent = `#${tag.name}`;
                            tagDiv.onclick = () => {
                                composeTextarea.value += ` #${tag.name} `;
                                autocompleteList.classList.remove('visible');
                                composeTextarea.focus();
                            };
                            autocompleteList.appendChild(tagDiv);
                        });
                        autocompleteList.classList.add('visible');
                    }
                } catch (error) {
                    alert('Could not fetch trending tags.');
                }
            }

            // Hide autocomplete when clicking away
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#autocomplete-container') && !e.target.closest('#trending-tags-btn')) {
                    autocompleteList.classList.remove('visible');
                }
            });

            // --- Other Feature Functions (fetchTimeline, showProfile, etc.) as before ---
            
            // --- App Initialization & Event Listeners ---
            async function initializeApp() { /* as before */ }
            trendingTagsBtn.addEventListener('click', showTrendingTags);
            composeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = composeTextarea.value.trim();
                if (!text) return;
                try {
                    await apiFetch('/api/v1/statuses', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: text })
                    });
                    composeTextarea.value = '';
                    fetchTimeline('home');
                } catch (error) { alert('Failed to post.'); }
            });
            // Rest of the event listeners and init logic...
            
            // Dummy functions and logic for brevity
            function showProfile(id) { alert(`Showing profile for ID ${id}`); }
            async function fetchTimeline(type) {
                timelineDiv.innerHTML = `<p>Loading ${type} timeline...</p>`;
            }
            // A simplified init for demonstration
            const loginForm = document.getElementById('login-view');
            const topNav = document.querySelector('.top-nav');
            function initializeApp() {
                loginForm.style.display = 'none';
                appView.style.display = 'block';
                topNav.style.display = 'flex';
                fetchTimeline('home');
            }
            // Check for saved login to bypass
            if(false) { // replace with actual localStorage check
                initializeApp();
            } else {
                topNav.style.display = 'none';
                appView.style.display = 'none';
                loginForm.style.display = 'block';
            }
        });
    </script>
</body>
</html>
