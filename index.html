<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Feeds</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Alpine.js with plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
</head>
<body x-data="app()" x-init="init()">

    <div id="app-view">
        <div id="pull-to-refresh-indicator"></div>
        
        <!-- Navigation -->
        <nav class="top-nav" x-data="navigation()">
            <div class="nav-left">
                <button class="icon-button"
                        :class="{ 'loading': $store.ui.isLoading }"
                        @click="refresh()"
                        x-html="icons.refresh"></button>
                        
                <div class="dropdown" x-data="{ open: false }">
                    <button class="nav-button" @click="open = !open">Feeds</button>
                    <div class="dropdown-content" 
                         x-show="open" 
                         @click.away="open = false"
                         x-transition>
                        <a href="#" @click="setFeed('home'); open = false">Home</a>
                        <a href="#" @click="setFeed('merged'); open = false">Merged</a>
                        <hr>
                        <a href="#" @click="setFeed('lemmy'); open = false">Lemmy</a>
                        <a href="#" @click="setFeed('mastodon'); open = false">Mastodon</a>
                    </div>
                </div>
                
                <button class="nav-button" @click="$store.ui.currentView = 'discover'">Discover</button>
            </div>

            <div class="nav-center"></div>

            <div class="nav-right">
                <div class="dropdown" x-data="{ open: false }">
                    <button class="nav-button" @click="open = !open">Menu</button>
                    <div class="dropdown-content" 
                         x-show="open" 
                         @click.away="open = false"
                         x-transition>
                        <a href="#" @click="showCompose(); open = false">New Post</a>
                        <a href="#" @click="showProfile(); open = false">Profile</a>
                        <a href="#" @click="$store.ui.currentView = 'settings'; open = false">Settings</a>
                        <a href="#" @click="showHelp(); open = false">Help</a>
                    </div>
                </div>
                
                <button class="icon-button"
                        :class="{ 'unread': hasUnreadNotifications }"
                        @click="showProfile()"
                        x-html="icons.notifications + '<div class=\"notification-dot\"></div>'"></button>
            </div>
        </nav>
        
        <div id="loading-bar" :class="{ 'loading': $store.ui.isLoading }"></div>

        <div class="container">
            <!-- Timeline Sub Navigation -->
            <div class="timeline-sub-nav"
                 x-show="$store.ui.currentView === 'timeline' && ($store.ui.currentTimeline || $store.ui.currentLemmyFeed)"
                 x-data="timelineSubNav()">
                
                <div class="timeline-sub-nav-tabs">
                    <template x-if="$store.ui.currentLemmyFeed">
                        <div style="display: flex; flex: 1;">
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'Subscribed' }"
                                    @click="setLemmyFeed('Subscribed')">Subbed</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'All' }"
                                    @click="setLemmyFeed('All')">All</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentLemmyFeed === 'Local' }"
                                    @click="setLemmyFeed('Local')">Local</button>
                        </div>
                    </template>
                    
                    <template x-if="$store.ui.currentTimeline">
                        <div style="display: flex; flex: 1;">
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline === 'home' }"
                                    @click="setMastodonTimeline('home')">Home</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline === 'public' }"
                                    @click="setMastodonTimeline('public')">Public</button>
                            <button class="timeline-sub-nav-btn" 
                                    :class="{ 'active': $store.ui.currentTimeline.includes('local') }"
                                    @click="setMastodonTimeline('public?local=true')">Local</button>
                        </div>
                    </template>
                </div>
                
                <template x-if="$store.ui.currentLemmyFeed">
                    <div style="margin-left: auto;">
                        <select x-model="$store.ui.currentLemmySort"
                                @change="setLemmyFeed($store.ui.currentLemmyFeed, $event.target.value)">
                            <option value="New">New</option>
                            <option value="Active">Active</option>
                            <option value="Hot">Hot</option>
                            <option value="TopDay">Top Day</option>
                            <option value="TopWeek">Top Week</option>
                        </select>
                    </div>
                </template>
            </div>

            <!-- Main Timeline View -->
            <div x-show="$store.ui.currentView === 'timeline'" 
                 x-data="timeline()" 
                 x-init="init()">
                 
                <!-- Loading State -->
                <template x-if="$store.ui.isLoading && $store.posts.length === 0">
                    <div class="loading-state" style="text-align: center; padding: 40px;">
                        <div x-html="icons.refresh" style="animation: spin 1s linear infinite; width: 32px; height: 32px; margin: 0 auto 16px;"></div>
                        <div>Loading your feed...</div>
                    </div>
                </template>
                
                <!-- Login Prompt -->
                <template x-if="!$store.ui.isLoading && $store.posts.length === 0 && needsLogin">
                    <div class="login-prompt" x-data="loginPrompt()">
                        <h3>Connect to get started</h3>
                        <p>Please log in to see your feed.</p>
                        
                        <!-- Lemmy Login -->
                        <template x-if="showingLemmyLogin">
                            <div class="login-form" style="background: var(--card-color); padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h4>Connect to Lemmy</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <input type="text" 
                                           x-model="lemmy.instance" 
                                           placeholder="Instance (e.g., lemmy.world)"
                                           style="padding: 10px;">
                                    <input type="text" 
                                           x-model="lemmy.username" 
                                           placeholder="Username"
                                           style="padding: 10px;">
                                    <input type="password" 
                                           x-model="lemmy.password" 
                                           placeholder="Password"
                                           style="padding: 10px;"
                                           @keyup.enter="loginLemmy()">
                                    <div style="display: flex; gap: 10px;">
                                        <button class="button-primary" 
                                                @click="loginLemmy()"
                                                :disabled="loggingIn">
                                            <span x-show="!loggingIn">Connect</span>
                                            <span x-show="loggingIn">Connecting...</span>
                                        </button>
                                        <button class="button-secondary" @click="showingLemmyLogin = false">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Mastodon Login -->
                        <template x-if="showingMastodonLogin">
                            <div class="login-form" style="background: var(--card-color); padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h4>Connect to Mastodon</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <input type="text" 
                                           x-model="mastodon.instance" 
                                           placeholder="Instance (e.g., mastodon.social)"
                                           style="padding: 10px;">
                                    <input type="text" 
                                           x-model="mastodon.token" 
                                           placeholder="Access Token"
                                           style="padding: 10px;"
                                           @keyup.enter="loginMastodon()">
                                    <div style="display: flex; gap: 10px;">
                                        <button class="button-primary" 
                                                @click="loginMastodon()"
                                                :disabled="loggingIn">
                                            <span x-show="!loggingIn">Connect</span>
                                            <span x-show="loggingIn">Connecting...</span>
                                        </button>
                                        <button class="button-secondary" @click="showingMastodonLogin = false">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Login Options -->
                        <template x-if="!showingLemmyLogin && !showingMastodonLogin">
                            <div class="login-options" style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
                                <button class="button-primary" @click="showingLemmyLogin = true">Connect Lemmy</button>
                                <button class="button-primary" @click="showingMastodonLogin = true">Connect Mastodon</button>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- Posts Feed -->
                <template x-if="$store.posts.length > 0">
                    <div class="posts-container" style="display: flex; flex-direction: column; gap: 15px;">
                        <template x-for="(post, index) in $store.posts" :key="getPostKey(post)">
                            <div x-data="postCard(post)" x-html="renderPost()"></div>
                        </template>
                    </div>
                </template>
                
                <!-- Load More Trigger -->
                <div x-intersect="loadMore()" 
                     x-show="$store.posts.length > 0"
                     style="text-align: center; padding: 20px;">
                    <template x-if="$store.ui.loadingMore">
                        <div>
                            <div x-html="icons.refresh" style="animation: spin 1s linear infinite; width: 24px; height: 24px; margin: 0 auto 8px;"></div>
                            <p>Loading more posts...</p>
                        </div>
                    </template>
                    <template x-if="!$store.ui.loadingMore && !$store.ui.hasMore">
                        <p style="color: var(--font-color-muted);">No more posts to load</p>
                    </template>
                </div>
            </div>

            <!-- Other Views -->
            <div x-show="$store.ui.currentView === 'discover'" x-data="discover()" x-init="init()">
                <h2>Discover</h2>
                <p>Discover functionality coming soon!</p>
            </div>
            
            <div x-show="$store.ui.currentView === 'settings'" x-data="settings()" x-init="init()">
                <div class="settings-container">
                    <h2>Settings</h2>
                    
                    <div class="settings-section">
                        <h3>Theme</h3>
                        <select x-model="$store.settings.theme" @change="setTheme($event.target.value)">
                            <option value="feedstodon">Feedstodon (Default)</option>
                            <option value="readit">Readit</option>
                            <option value="git">Git</option>
                            <option value="voyage">Voyage</option>
                        </select>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Default Feed</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <label>Default Platform:</label>
                                <select x-model="$store.settings.defaultStartPage">
                                    <option value="lemmy">Lemmy</option>
                                    <option value="mastodon">Mastodon</option>
                                </select>
                            </div>
                            <div>
                                <label>Default Feed Type:</label>
                                <select x-model="$store.settings.defaultFeedType">
                                    <option value="Subscribed">Subscribed</option>
                                    <option value="Local">Local</option>
                                    <option value="All">All</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Account</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <template x-if="isLoggedInToLemmy()">
                                <div style="padding: 10px; background: var(--card-color); border-radius: 8px;">
                                    <strong>Lemmy:</strong> <span x-text="$store.auth.lemmy.username + '@' + $store.auth.lemmy.instance"></span>
                                    <button class="button-secondary" style="margin-left: 10px;" @click="logoutLemmy()">Logout</button>
                                </div>
                            </template>
                            
                            <template x-if="isLoggedInToMastodon()">
                                <div style="padding: 10px; background: var(--card-color); border-radius: 8px;">
                                    <strong>Mastodon:</strong> <span x-text="$store.auth.mastodon.currentUser?.display_name || 'Connected'"></span>
                                    <button class="button-secondary" style="margin-left: 10px;" @click="logoutMastodon()">Logout</button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            
            <div x-show="$store.ui.currentView === 'notifications'">
                <h2>Notifications</h2>
                <p>Notifications functionality coming soon!</p>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="toast-notification" x-data="{ message: '', visible: false }" 
         :class="{ 'visible': visible }"
         x-text="message"
         @toast.window="message = $event.detail; visible = true; setTimeout(() => visible = false, 3000)"></div>
    
    <div class="modal-overlay" x-data="{ visible: false }" 
         :class="{ 'visible': visible }"
         @compose-modal.window="visible = true"
         @click="if ($event.target === $el) visible = false">
        <div class="modal-content" @click.stop>
            <h3>New Post</h3>
            <p>Compose functionality will be implemented next!</p>
            <button class="button-secondary" @click="visible = false">Close</button>
        </div>
    </div>
    
    <div class="modal-overlay" x-data="{ visible: false }" 
         :class="{ 'visible': visible }"
         @help-modal.window="visible = true"
         @click="if ($event.target === $el) visible = false">
        <div class="modal-content" @click.stop>
            <h3>Welcome to Alpine.js Feedstodon!</h3>
            <p>This is the new reactive version with:</p>
            <ul>
                <li>✅ Reactive state management</li>
                <li>✅ Automatic UI updates</li>
                <li>✅ No manual DOM manipulation</li>
                <li>✅ Better performance</li>
                <li>✅ Easier debugging</li>
            </ul>
            <button class="button-primary" @click="visible = false">Got it!</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="components/store.js"></script>
    <script src="components/actions.js"></script>
    <script src="components/components.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .login-form input {
            font-family: inherit;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--font-color);
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .settings-section {
            background: var(--card-color);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .settings-section select {
            background: var(--bg-color);
            color: var(--font-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
        }
        
        .settings-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</body>
</html>
